<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Duplicate Analysis Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header {
            background: white; border-radius: 16px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 { font-size: 2.5rem; color: #2d3748; margin-bottom: 10px; }
        .header p { color: #718096; font-size: 1.1rem; }
        
        .summary-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        
        .summary-card {
            background: white; border-radius: 12px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;
            transition: transform 0.2s;
        }
        
        .summary-card:hover { transform: translateY(-2px); }
        .summary-card h3 { font-size: 2.5rem; margin-bottom: 5px; font-weight: bold; }
        .summary-card.primary h3 { color: #667eea; }
        .summary-card.warning h3 { color: #f6ad55; }
        .summary-card.success h3 { color: #48bb78; }
        .summary-card.info h3 { color: #4299e1; }
        .summary-card p { color: #718096; font-size: 0.95rem; }
        
        .transcript-section {
            background: white; border-radius: 16px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .transcript-section h2 {
            color: #2d3748; margin-bottom: 20px; font-size: 1.8rem;
            border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;
        }
        
        .transcript-controls {
            margin-bottom: 15px; padding: 10px; background: #f7fafc;
            border-radius: 8px; display: flex; gap: 10px; flex-wrap: wrap;
        }
        
        .create-group-button, .edit-groups-button, .toggle-edit-mode, .save-transcript-button, .download-transcript-button {
            background: #4299e1; color: white; border: none; padding: 10px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            transition: background 0.2s; margin-right: 8px;
        }
        
        .edit-groups-button {
            background: #9f7aea;
        }
        
        .edit-groups-button:hover {
            background: #805ad5;
        }
        
        .create-group-button:hover, .toggle-edit-mode:hover, .save-transcript-button:hover, .download-transcript-button:hover {
            background: #3182ce;
        }
        
        .save-transcript-button {
            background: #48bb78;
        }
        
        .save-transcript-button:hover {
            background: #38a169;
        }
        
        .download-transcript-button {
            background: #ed8936;
        }
        
        .download-transcript-button:hover {
            background: #dd6b20;
        }
        
        .save-status {
            margin-left: auto; padding: 6px 12px; border-radius: 4px;
            font-size: 0.85rem; font-weight: 500; opacity: 0;
            transition: opacity 0.3s;
        }
        
        .save-status.success {
            background: #c6f6d5; color: #22543d;
            opacity: 1;
        }
        
        .save-status.error {
            background: #fed7d7; color: #742a2a;
            opacity: 1;
        }
        
        .edit-indicator {
            background: #fef5e7; border: 1px solid #f6ad55;
            padding: 8px 12px; border-radius: 6px; margin-bottom: 15px;
            color: #744210; font-size: 0.9rem; display: none;
            align-items: center; gap: 8px;
        }
        
        .edit-indicator.show {
            display: flex;
        }
        
        .word-count {
            margin-left: auto; font-size: 0.8rem; color: #718096;
            background: #edf2f7; padding: 4px 8px; border-radius: 4px;
        }
        
        .transcript-paragraph {
            font-size: 1.1rem; line-height: 1.6; color: #2d3748;
            padding: 25px; background: #f8f9fa; border-radius: 12px;
            position: relative; min-height: 200px;
        }
        
        .transcript-line {
            margin-bottom: 12px; position: relative; padding: 8px 0;
            border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s;
            display: flex; align-items: flex-start; gap: 8px;
        }
        
        .segment-controls {
            display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;
            flex-shrink: 0; margin-top: 2px;
        }
        
        .transcript-line:hover .segment-controls {
            opacity: 1;
        }
        
        .segment-group-btn, .segment-play-btn, .segment-split-btn, .segment-merge-btn {
            background: #edf2f7; border: 1px solid #cbd5e0; border-radius: 4px;
            padding: 2px 6px; cursor: pointer; font-size: 0.8rem;
            transition: all 0.2s; line-height: 1;
        }
        
        .segment-group-btn:hover, .segment-play-btn:hover {
            background: #4299e1; color: white; border-color: #4299e1;
        }
        
        .segment-split-btn {
            background: #fbb6ce; border-color: #f687b3;
        }
        
        .segment-split-btn:hover {
            background: #ed64a6; color: white; border-color: #ed64a6;
        }
        
        .segment-merge-btn {
            background: #c6f6d5; border-color: #9ae6b4;
        }
        
        .segment-merge-btn:hover {
            background: #48bb78; color: white; border-color: #48bb78;
        }
        
        .segment-merge-btn.active {
            background: #48bb78; color: white; border-color: #48bb78;
        }
        
        .transcript-line.merge-selected {
            background: rgba(72, 187, 120, 0.1); border-radius: 6px;
            border: 2px solid #48bb78;
        }
        
        .transcript-line:hover {
            background-color: rgba(66, 153, 225, 0.05);
            border-radius: 6px;
        }
        
        .transcript-segment {
            cursor: pointer; padding: 3px 6px; border-radius: 4px;
            transition: all 0.2s ease; display: inline; position: relative;
            border-bottom: 1px solid transparent; font-size: 1.05rem;
            line-height: 1.5;
        }
        
        .transcript-segment:hover {
            background: rgba(66, 153, 225, 0.1); border-bottom-color: #4299e1;
        }
        
        .transcript-segment[contenteditable="true"] {
            background: white; border: 1px solid #4299e1;
            padding: 4px 8px; border-radius: 4px; outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 1.05rem;
        }
        
        .segment-timestamp {
            font-size: 0.75rem; color: #718096; margin-top: 6px;
            font-weight: 500; opacity: 0.7; font-family: 'Monaco', 'Menlo', monospace;
            background: #edf2f7; padding: 2px 6px; border-radius: 3px;
            display: inline-block;
        }
        
        .duplicate-highlight {
            font-weight: 600; border-radius: 4px; padding: 3px 8px;
            position: relative; border-bottom: 2px solid;
        }
        
        .duplicate-highlight:hover {
            transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .duplicate-highlight.duplicate-group-1 {
            background: #fed7d7; color: #c53030; border-bottom-color: #f56565;
        }
        .duplicate-highlight.duplicate-group-1:hover { background: #fc8181; color: white; }
        
        .duplicate-highlight.duplicate-group-2 {
            background: #feebc8; color: #c05621; border-bottom-color: #ed8936;
        }
        .duplicate-highlight.duplicate-group-2:hover { background: #f6ad55; color: white; }
        
        .duplicate-highlight.duplicate-group-3 {
            background: #b2f5ea; color: #2c7a7b; border-bottom-color: #38b2ac;
        }
        .duplicate-highlight.duplicate-group-3:hover { background: #4fd1c5; color: white; }
        
        .video-section {
            background: white; border-radius: 16px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .video-section h2 { color: #2d3748; margin-bottom: 20px; font-size: 1.5rem; }
        
        .grid-controls {
            background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
        }
        
        .grid-size-control, .group-selector {
            display: flex; align-items: center; gap: 10px;
        }
        
        .grid-size-control label, .group-selector label {
            font-weight: 500; color: #4a5568;
        }
        
        .grid-size-control select, .group-selector select {
            padding: 6px 10px; border: 1px solid #cbd5e0; border-radius: 4px;
            background: white; color: #2d3748; min-width: 120px;
        }
        
        .grid-info {
            margin-left: auto; padding: 8px 12px; background: #edf2f7;
            border-radius: 6px; font-size: 0.9rem; color: #4a5568;
        }
        
        .video-grid {
            display: grid; gap: 15px; margin-bottom: 20px;
            grid-template-columns: repeat(2, 1fr); /* Default 2 videos */
            min-height: 400px; max-width: 100%;
        }
        
        .video-grid.size-1 { grid-template-columns: repeat(1, 1fr); }
        .video-grid.size-2 { grid-template-columns: repeat(2, 1fr); }
        .video-grid.size-4 { 
            grid-template-columns: repeat(2, 1fr); 
            grid-template-rows: repeat(2, 1fr);
        }
        
        .grid-placeholder {
            grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 60px 20px; color: #718096;
            background: #f8f9fa; border-radius: 12px; border: 2px dashed #cbd5e0;
        }
        
        .placeholder-icon {
            font-size: 3rem; margin-bottom: 15px;
        }
        
        .video-item {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .video-item:hover {
            transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #4299e1;
        }
        
        .video-item.active {
            border-color: #48bb78; box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
        }
        
        .video-header {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white;
            padding: 10px 12px; font-size: 0.9rem; font-weight: 600;
        }
        
        .video-content {
            position: relative; background: #000; width: 100%; height: 100%;
            min-height: 200px; display: flex; align-items: center; justify-content: center;
        }
        
        .video-item video {
            width: 100%; height: 100%; object-fit: contain; /* Use 'contain' to maintain aspect ratio */
            max-width: 100%; max-height: 100%;
        }
        
        .video-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white; padding: 8px 12px; font-size: 0.8rem;
        }
        
        .video-time {
            font-family: monospace; opacity: 0.9;
        }
        
        .video-text {
            margin-top: 4px; line-height: 1.3; max-height: 2.6em;
            overflow: hidden; text-overflow: ellipsis;
        }
        
        .video-controls-panel {
            background: #f7fafc; padding: 15px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 15px;
        }
        
        .clip-controls {
            display: flex; gap: 15px; align-items: center;
        }
        
        .clip-controls label {
            display: flex; align-items: center; gap: 5px; cursor: pointer;
            font-size: 0.9rem; color: #4a5568;
        }
        
        .grid-info-text {
            margin-left: auto; padding: 8px 12px; background: #edf2f7;
            border-radius: 6px; font-size: 0.9rem; color: #4a5568;
        }
        
        /* Group Management UI */
        .segment-group-menu {
            position: fixed; background: white; border: 1px solid #cbd5e0;
            border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000; min-width: 200px; display: none;
        }
        
        .group-menu-header {
            padding: 12px 16px; font-weight: 600; color: #2d3748;
            border-bottom: 1px solid #e2e8f0; background: #f7fafc;
            border-radius: 8px 8px 0 0;
        }
        
        .group-menu-item {
            padding: 10px 16px; cursor: pointer; transition: background 0.2s;
            border-bottom: 1px solid #f7fafc; font-size: 0.9rem;
        }
        
        .group-menu-item:hover {
            background: #edf2f7;
        }
        
        .group-menu-item.selected {
            background: #4299e1; color: white;
        }
        
        .group-menu-divider {
            height: 1px; background: #e2e8f0; margin: 4px 0;
        }
        
        .group-editor-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 2000; display: flex;
            align-items: center; justify-content: center; padding: 20px;
        }
        
        .group-editor {
            background: white; border-radius: 12px; max-width: 800px;
            max-height: 80vh; width: 100%; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .group-editor-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }
        
        .group-editor-header h3 {
            margin: 0; color: #2d3748; font-size: 1.3rem;
        }
        
        .close-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer;
            color: #718096; padding: 4px; border-radius: 4px; transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #fed7d7; color: #c53030;
        }
        
        .group-editor-content {
            padding: 24px; overflow-y: auto; max-height: calc(80vh - 80px);
        }
        
        .no-groups-message {
            text-align: center; padding: 40px; color: #718096;
        }
        
        .group-editor-group {
            margin-bottom: 32px; border: 1px solid #e2e8f0; border-radius: 8px;
            overflow: hidden;
        }
        
        .group-editor-group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; background: #f7fafc; border-bottom: 1px solid #e2e8f0;
        }
        
        .group-editor-group-header h4 {
            margin: 0; color: #2d3748; font-size: 1.1rem;
        }
        
        .group-actions {
            display: flex; gap: 8px;
        }
        
        .group-action-btn {
            background: #4299e1; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.8rem;
            transition: background 0.2s;
        }
        
        .group-action-btn:hover {
            background: #3182ce;
        }
        
        .group-action-btn.delete {
            background: #e53e3e;
        }
        
        .group-action-btn.delete:hover {
            background: #c53030;
        }
        
        .group-segments {
            padding: 16px 20px;
        }
        
        .group-segment-item {
            display: flex; align-items: flex-start; gap: 12px; padding: 12px;
            border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;
            transition: background 0.2s; position: relative;
        }
        
        .group-segment-item:hover {
            background: #f7fafc;
        }
        
        .segment-info {
            display: flex; align-items: center; gap: 8px; flex-shrink: 0;
            font-size: 0.85rem; color: #4a5568;
        }
        
        .segment-index {
            font-weight: 600; color: #2d3748;
        }
        
        .segment-play-small {
            background: #48bb78; color: white; border: none; padding: 2px 6px;
            border-radius: 3px; cursor: pointer; font-size: 0.7rem;
        }
        
        .segment-text {
            flex: 1; line-height: 1.4; color: #2d3748; font-size: 0.9rem;
        }
        
        .remove-segment-btn {
            background: #fed7d7; color: #c53030; border: none; padding: 4px 8px;
            border-radius: 4px; cursor: pointer; font-size: 0.8rem; opacity: 0;
            transition: opacity 0.2s;
        }
        
        .group-segment-item:hover .remove-segment-btn {
            opacity: 1;
        }
        
        /* Split Dialog Styles */
        .split-dialog-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 3000; display: flex;
            align-items: center; justify-content: center; padding: 20px;
        }
        
        .split-dialog {
            background: white; border-radius: 12px; max-width: 600px;
            width: 100%; max-height: 80vh; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .split-dialog-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }
        
        .split-dialog-header h3 {
            margin: 0; color: #2d3748; font-size: 1.3rem;
        }
        
        .split-dialog-content {
            padding: 24px; overflow-y: auto; max-height: calc(80vh - 80px);
        }
        
        .words-container {
            margin: 20px 0; padding: 16px; background: #f7fafc;
            border-radius: 8px; font-size: 1.1rem; line-height: 1.6;
        }
        
        .word-item {
            cursor: pointer; padding: 2px 4px; border-radius: 3px;
            transition: background 0.2s; margin: 0 2px;
        }
        
        .word-item:hover {
            background: #edf2f7;
        }
        
        .word-item.part1 {
            background: rgba(66, 153, 225, 0.2); color: #2c5282;
        }
        
        .word-item.part2 {
            background: rgba(237, 137, 54, 0.2); color: #c05621;
        }
        
        .split-preview {
            margin: 20px 0; padding: 16px; background: #edf2f7;
            border-radius: 8px;
        }
        
        .preview-part {
            margin-bottom: 12px; padding: 12px; background: white;
            border-radius: 6px; border-left: 4px solid #4299e1;
        }
        
        .preview-part:last-child {
            border-left-color: #ed8936;
            margin-bottom: 0;
        }
        
        .split-dialog-actions {
            display: flex; gap: 12px; justify-content: flex-end;
            margin-top: 24px;
        }
        
        .cancel-btn {
            background: #e2e8f0; color: #4a5568; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; transition: background 0.2s;
        }
        
        .cancel-btn:hover {
            background: #cbd5e0;
        }
        
        .split-confirm-btn {
            background: #4299e1; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; transition: background 0.2s;
        }
        
        .split-confirm-btn:hover {
            background: #3182ce;
        }
        
        .split-confirm-btn:disabled {
            background: #cbd5e0; cursor: not-allowed;
        }
        
        /* Merge Instructions */
        .merge-instructions {
            background: #edf2f7; border: 2px solid #4299e1; border-radius: 8px;
            padding: 16px; margin-bottom: 20px; text-align: center;
        }
        
        .merge-instructions-content {
            display: flex; align-items: center; justify-content: center;
            gap: 20px; flex-wrap: wrap;
        }
        
        .merge-confirm-btn {
            background: #48bb78; color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; transition: background 0.2s;
        }
        
        .merge-confirm-btn:hover:not(:disabled) {
            background: #38a169;
        }
        
        .merge-confirm-btn:disabled {
            background: #cbd5e0; cursor: not-allowed;
        }
        
        .merge-cancel-btn {
            background: #e53e3e; color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; transition: background 0.2s;
        }
        
        .merge-cancel-btn:hover {
            background: #c53030;
        }
        
        .master-pause-btn { background: #ed8936; }
        .master-reset-btn { background: #718096; }
        
        .master-play-btn:hover { background: #3182ce; }
        .master-pause-btn:hover { background: #dd6b20; }
        .master-reset-btn:hover { background: #4a5568; }
        
        .grid-pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 20px; padding: 10px;
            background: #f7fafc; border-radius: 8px;
        }
        
        .pagination-btn {
            background: #4299e1; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) { background: #3182ce; }
        .pagination-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        
        .page-info {
            font-weight: 500; color: #4a5568; font-size: 0.9rem;
        }
        
        .duplicates-section {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .duplicates-section h2 { color: #2d3748; margin-bottom: 25px; font-size: 1.5rem; }
        
        .duplicate-group {
            background: #f7fafc; border-radius: 12px; padding: 25px;
            margin-bottom: 25px; border-left: 5px solid #667eea;
        }
        
        .group-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        
        .group-title { font-size: 1.3rem; color: #2d3748; font-weight: 600; }
        
        .similarity-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 8px 16px; border-radius: 20px;
            font-weight: bold; font-size: 0.9rem;
        }
        
        .edit-group-button, .add-segment-button, .remove-group-button {
            background: #4299e1; color: white; border: none; padding: 6px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-left: 8px;
        }
        
        .remove-group-button { background: #e53e3e; }
        
        .segments-grid { display: grid; gap: 15px; }
        
        .segment-card {
            background: white; border-radius: 8px; padding: 20px;
            border: 2px solid #e2e8f0; transition: all 0.2s; cursor: pointer;
        }
        
        .segment-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1); }
        
        .segment-card.recommended { border-color: #48bb78; background: linear-gradient(135deg, #f0fff4, #ffffff); }
        
        .segment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        
        .segment-time {
            background: #edf2f7; color: #4a5568; padding: 4px 10px;
            border-radius: 6px; font-size: 0.85rem; font-weight: 600;
        }
        
        .segment-text { color: #2d3748; line-height: 1.6; font-size: 1rem; }
        
        .segment-edit-input {
            width: 100%; padding: 8px; border: 1px solid #cbd5e0;
            border-radius: 4px; font-size: 1rem; margin-top: 8px;
        }
        
        .play-button, .edit-button {
            background: #667eea; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin-left: 8px;
        }
        
        .edit-button { background: #ed8936; }
        
        .group-edit-controls {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;
        }
        
        .no-duplicates {
            text-align: center; padding: 60px 20px; color: #718096;
        }
        
        .footer { text-align: center; margin-top: 40px; padding: 20px; color: white; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Interactive Duplicate Analysis</h1>
            <p>Edit and manage duplicate groups with real-time updates</p>
        </div>

        <div class="summary-cards">
            <div class="summary-card primary">
                <h3>32</h3>
                <p>Total Segments</p>
            </div>
            <div class="summary-card warning">
                <h3>8</h3>
                <p>Duplicate Groups</p>
            </div>
            <div class="summary-card success">
                <h3>0.0s</h3>
                <p>Processing Time</p>
            </div>
            <div class="summary-card info">
                <h3>llama3.1:8b</h3>
                <p>AI Model</p>
            </div>
        </div>

        <div class="transcript-section"><h2>üìù Interactive Transcript</h2><p>Click any highlighted segment to play or edit. Duplicate segments are color-coded and can be grouped/ungrouped.</p><div class="transcript-controls"><button class="create-group-button" onclick="createNewGroup()">‚ûï Create New Group</button><button class="edit-groups-button" onclick="openGroupEditor()">üìù Edit Groups</button><button class="toggle-edit-mode" onclick="toggleEditMode()">‚úèÔ∏è Toggle Edit Mode</button><button class="save-transcript-button" onclick="saveTranscript()" id="saveButton" style="display:none;">üíæ Save Transcript</button><button class="download-transcript-button" onclick="downloadTranscript()">üì• Download</button><div class="save-status" id="saveStatus"></div></div><div class="edit-indicator" id="editIndicator">‚úèÔ∏è <strong>Edit Mode Active</strong> - Click any segment to edit. Changes are auto-saved to browser storage.<span class="word-count" id="wordCount">0 words</span></div><div class="transcript-paragraph">
                <div class="transcript-line" data-segment-id="seg_0">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_0', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(1.68, 6.7)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_0', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_0', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-1" 
                          data-group="1" data-segment-id="seg_0"
                          data-start="1.68" 
                          data-end="6.7"
                          data-segment-id="seg_0"
                          data-words-count="0"
                          title="00:01 - 00:06"
                          onclick="handleSegmentClick(this, 1.68, 6.7, 'seg_0')"
                          contenteditable="false">Where there was not God's book and then there was.</span>
                    <div class="segment-timestamp">00:01</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_1">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_1', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(7.68, 10.7)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_1', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_1', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="7.68" 
                          data-end="10.7"
                          data-segment-id="seg_1"
                          data-words-count="0"
                          title="00:07 - 00:10"
                          onclick="handleSegmentClick(this, 7.68, 10.7, 'seg_1')"
                          contenteditable="false">Welcome to Life is Your Word episode 3.</span>
                    <div class="segment-timestamp">00:07</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_2">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_2', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(11.68, 17.7)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_2', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_2', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-2" 
                          data-group="2" data-segment-id="seg_2"
                          data-start="11.68" 
                          data-end="17.7"
                          data-segment-id="seg_2"
                          data-words-count="0"
                          title="00:11 - 00:17"
                          onclick="handleSegmentClick(this, 11.68, 17.7, 'seg_2')"
                          contenteditable="false">In this show, we build up our understanding of reality by seeking God's face.</span>
                    <div class="segment-timestamp">00:11</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_3">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_3', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(20.44, 22.46)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_3', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_3', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-3" 
                          data-group="3" data-segment-id="seg_3"
                          data-start="20.44" 
                          data-end="22.46"
                          data-segment-id="seg_3"
                          data-words-count="0"
                          title="00:20 - 00:22"
                          onclick="handleSegmentClick(this, 20.44, 22.46, 'seg_3')"
                          contenteditable="false">Today's reading is from Genesis chapter 1.</span>
                    <div class="segment-timestamp">00:20</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_4">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_4', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(27.200000000000003, 34.11)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_4', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_4', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-4" 
                          data-group="4" data-segment-id="seg_4"
                          data-start="27.200000000000003" 
                          data-end="34.11"
                          data-segment-id="seg_4"
                          data-words-count="0"
                          title="00:27 - 00:34"
                          onclick="handleSegmentClick(this, 27.200000000000003, 34.11, 'seg_4')"
                          contenteditable="false">When God began to create the heavens and the earth, the earth was in complete chaos and</span>
                    <div class="segment-timestamp">00:27</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_5">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_5', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(35.010000000000005, 42.42)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_5', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_5', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="35.010000000000005" 
                          data-end="42.42"
                          data-segment-id="seg_5"
                          data-words-count="0"
                          title="00:35 - 00:42"
                          onclick="handleSegmentClick(this, 35.010000000000005, 42.42, 'seg_5')"
                          contenteditable="false">darkness covered the face of the deep while a wind of God, while a wind from God</span>
                    <div class="segment-timestamp">00:35</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_6">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_6', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(43.760000000000005, 45.349000000000004)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_6', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_6', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-5" 
                          data-group="5" data-segment-id="seg_6"
                          data-start="43.760000000000005" 
                          data-end="45.349000000000004"
                          data-segment-id="seg_6"
                          data-words-count="0"
                          title="00:43 - 00:45"
                          onclick="handleSegmentClick(this, 43.760000000000005, 45.349000000000004, 'seg_6')"
                          contenteditable="false">swept over the face of the waters.</span>
                    <div class="segment-timestamp">00:43</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_7">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_7', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(47.803, 50.74)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_7', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_7', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-1" 
                          data-group="1" data-segment-id="seg_7"
                          data-start="47.803" 
                          data-end="50.74"
                          data-segment-id="seg_7"
                          data-words-count="0"
                          title="00:47 - 00:50"
                          onclick="handleSegmentClick(this, 47.803, 50.74, 'seg_7')"
                          contenteditable="false">Then God said, let there be light and there was light.</span>
                    <div class="segment-timestamp">00:47</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_8">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_8', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(52.28, 58.11)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_8', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_8', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-1" 
                          data-group="1" data-segment-id="seg_8"
                          data-start="52.28" 
                          data-end="58.11"
                          data-segment-id="seg_8"
                          data-words-count="0"
                          title="00:52 - 00:58"
                          onclick="handleSegmentClick(this, 52.28, 58.11, 'seg_8')"
                          contenteditable="false">And God saw, and God saw that the light was good and</span>
                    <div class="segment-timestamp">00:52</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_9">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_9', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(59.53, 61.95)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_9', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_9', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-3" 
                          data-group="3" data-segment-id="seg_9"
                          data-start="59.53" 
                          data-end="61.95"
                          data-segment-id="seg_9"
                          data-words-count="0"
                          title="00:59 - 01:01"
                          onclick="handleSegmentClick(this, 59.53, 61.95, 'seg_9')"
                          contenteditable="false">God separated the light from the darkness.</span>
                    <div class="segment-timestamp">00:59</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_10">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_10', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(62.49, 65.87)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_10', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_10', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-5" 
                          data-group="5" data-segment-id="seg_10"
                          data-start="62.49" 
                          data-end="65.87"
                          data-segment-id="seg_10"
                          data-words-count="0"
                          title="01:02 - 01:05"
                          onclick="handleSegmentClick(this, 62.49, 65.87, 'seg_10')"
                          contenteditable="false">God created humans in the image of God.</span>
                    <div class="segment-timestamp">01:02</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_11">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_11', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(67.00999999999999, 72.456)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_11', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_11', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="67.00999999999999" 
                          data-end="72.456"
                          data-segment-id="seg_11"
                          data-words-count="0"
                          title="01:07 - 01:12"
                          onclick="handleSegmentClick(this, 67.00999999999999, 72.456, 'seg_11')"
                          contenteditable="false">God blessed them, saying be fruitful and fill the earth.</span>
                    <div class="segment-timestamp">01:07</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_12">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_12', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(74.104, 75.43)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_12', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_12', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-6" 
                          data-group="6" data-segment-id="seg_12"
                          data-start="74.104" 
                          data-end="75.43"
                          data-segment-id="seg_12"
                          data-words-count="0"
                          title="01:14 - 01:15"
                          onclick="handleSegmentClick(this, 74.104, 75.43, 'seg_12')"
                          contenteditable="false">I have given you everything.</span>
                    <div class="segment-timestamp">01:14</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_13">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_13', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(79.62, 90.64000000000001)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_13', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_13', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-4" 
                          data-group="4" data-segment-id="seg_13"
                          data-start="79.62" 
                          data-end="90.64000000000001"
                          data-segment-id="seg_13"
                          data-words-count="0"
                          title="01:19 - 01:30"
                          onclick="handleSegmentClick(this, 79.62, 90.64000000000001, 'seg_13')"
                          contenteditable="false">In my past death, I lived in complete chaos and the great darkness of depression covered my face.</span>
                    <div class="segment-timestamp">01:19</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_14">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_14', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(90.62, 104.64000000000001)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_14', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_14', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="90.62" 
                          data-end="104.64000000000001"
                          data-segment-id="seg_14"
                          data-words-count="0"
                          title="01:30 - 01:44"
                          onclick="handleSegmentClick(this, 90.62, 104.64000000000001, 'seg_14')"
                          contenteditable="false">I stopped listening to God's voice and I tried to run my race in my strength, in my strength, and I tried to run my race in my strength, rather than by Christ living in me.</span>
                    <div class="segment-timestamp">01:30</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_15">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_15', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(104.62, 110.64000000000001)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_15', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_15', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-1" 
                          data-group="1" data-segment-id="seg_15"
                          data-start="104.62" 
                          data-end="110.64000000000001"
                          data-segment-id="seg_15"
                          data-words-count="0"
                          title="01:44 - 01:50"
                          onclick="handleSegmentClick(this, 104.62, 110.64000000000001, 'seg_15')"
                          contenteditable="false">But God's, but then God spoke and I became.</span>
                    <div class="segment-timestamp">01:44</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_16">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_16', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(110.62, 119.64000000000001)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_16', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_16', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-2" 
                          data-group="2" data-segment-id="seg_16"
                          data-start="110.62" 
                          data-end="119.64000000000001"
                          data-segment-id="seg_16"
                          data-words-count="0"
                          title="01:50 - 01:59"
                          onclick="handleSegmentClick(this, 110.62, 119.64000000000001, 'seg_16')"
                          contenteditable="false">Life filled me, peace beyond human understanding, joy that defied worldly authorities,</span>
                    <div class="segment-timestamp">01:50</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_17">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_17', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(119.62, 128.64000000000001)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_17', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_17', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="119.62" 
                          data-end="128.64000000000001"
                          data-segment-id="seg_17"
                          data-words-count="0"
                          title="01:59 - 02:08"
                          onclick="handleSegmentClick(this, 119.62, 128.64000000000001, 'seg_17')"
                          contenteditable="false">and I became compelled to shout God's praise from every mountaintop and share God's great works with everyone.</span>
                    <div class="segment-timestamp">01:59</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_18">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_18', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(131.42000000000002, 136.44000000000003)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_18', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_18', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="131.42000000000002" 
                          data-end="136.44000000000003"
                          data-segment-id="seg_18"
                          data-words-count="0"
                          title="02:11 - 02:16"
                          onclick="handleSegmentClick(this, 131.42000000000002, 136.44000000000003, 'seg_18')"
                          contenteditable="false">So I thank God regularly for my role in partaking in creation as</span>
                    <div class="segment-timestamp">02:11</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_19">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_19', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(137.10000000000002, 142.76000000000002)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_19', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_19', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-7" 
                          data-group="7" data-segment-id="seg_19"
                          data-start="137.10000000000002" 
                          data-end="142.76000000000002"
                          data-segment-id="seg_19"
                          data-words-count="0"
                          title="02:17 - 02:22"
                          onclick="handleSegmentClick(this, 137.10000000000002, 142.76000000000002, 'seg_19')"
                          contenteditable="false">I create these things for your benefit just as God created all things for our benefit.</span>
                    <div class="segment-timestamp">02:17</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_20">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_20', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(143.26000000000002, 148.44000000000003)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_20', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_20', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-8" 
                          data-group="8" data-segment-id="seg_20"
                          data-start="143.26000000000002" 
                          data-end="148.44000000000003"
                          data-segment-id="seg_20"
                          data-words-count="0"
                          title="02:23 - 02:28"
                          onclick="handleSegmentClick(this, 143.26000000000002, 148.44000000000003, 'seg_20')"
                          contenteditable="false">This reminds me, this reminds me that nothing is impossible</span>
                    <div class="segment-timestamp">02:23</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_21">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_21', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(149.46, 151.48000000000002)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_21', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_21', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="149.46" 
                          data-end="151.48000000000002"
                          data-segment-id="seg_21"
                          data-words-count="0"
                          title="02:29 - 02:31"
                          onclick="handleSegmentClick(this, 149.46, 151.48000000000002, 'seg_21')"
                          contenteditable="false">through Christ who gives me strength.</span>
                    <div class="segment-timestamp">02:29</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_22">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_22', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(153.51000000000002, 158.21)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_22', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_22', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-8" 
                          data-group="8" data-segment-id="seg_22"
                          data-start="153.51000000000002" 
                          data-end="158.21"
                          data-segment-id="seg_22"
                          data-words-count="0"
                          title="02:33 - 02:38"
                          onclick="handleSegmentClick(this, 153.51000000000002, 158.21, 'seg_22')"
                          contenteditable="false">This reminds me that nothing is impossible through Christ who gives me strength.</span>
                    <div class="segment-timestamp">02:33</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_23">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_23', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(159.19000000000003, 167.33)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_23', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_23', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-7" 
                          data-group="7" data-segment-id="seg_23"
                          data-start="159.19000000000003" 
                          data-end="167.33"
                          data-segment-id="seg_23"
                          data-words-count="0"
                          title="02:39 - 02:47"
                          onclick="handleSegmentClick(this, 159.19000000000003, 167.33, 'seg_23')"
                          contenteditable="false">The one who speaks all things into being can transform your life too.</span>
                    <div class="segment-timestamp">02:39</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_24">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_24', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(172.11, 175.45000000000002)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_24', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_24', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-6" 
                          data-group="6" data-segment-id="seg_24"
                          data-start="172.11" 
                          data-end="175.45000000000002"
                          data-segment-id="seg_24"
                          data-words-count="0"
                          title="02:52 - 02:55"
                          onclick="handleSegmentClick(this, 172.11, 175.45000000000002, 'seg_24')"
                          contenteditable="false">What death have you lived?</span>
                    <div class="segment-timestamp">02:52</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_25">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_25', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(177.11, 179.21)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_25', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_25', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="177.11" 
                          data-end="179.21"
                          data-segment-id="seg_25"
                          data-words-count="0"
                          title="02:57 - 02:59"
                          onclick="handleSegmentClick(this, 177.11, 179.21, 'seg_25')"
                          contenteditable="false">They...</span>
                    <div class="segment-timestamp">02:57</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_26">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_26', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(179.19, 182.13000000000002)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_26', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_26', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="179.19" 
                          data-end="182.13000000000002"
                          data-segment-id="seg_26"
                          data-words-count="0"
                          title="02:59 - 03:02"
                          onclick="handleSegmentClick(this, 179.19, 182.13000000000002, 'seg_26')"
                          contenteditable="false">What death have you experienced that he needs?</span>
                    <div class="segment-timestamp">02:59</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_27">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_27', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(185.36, 190.12000000000003)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_27', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_27', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-4" 
                          data-group="4" data-segment-id="seg_27"
                          data-start="185.36" 
                          data-end="190.12000000000003"
                          data-segment-id="seg_27"
                          data-words-count="0"
                          title="03:05 - 03:10"
                          onclick="handleSegmentClick(this, 185.36, 190.12000000000003, 'seg_27')"
                          contenteditable="false">What death have you experienced and how has he breathed life into your death and</span>
                    <div class="segment-timestamp">03:05</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_28">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_28', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(190.72000000000003, 201.33)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_28', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_28', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="190.72000000000003" 
                          data-end="201.33"
                          data-segment-id="seg_28"
                          data-words-count="0"
                          title="03:10 - 03:21"
                          onclick="handleSegmentClick(this, 190.72000000000003, 201.33, 'seg_28')"
                          contenteditable="false">How has he breathed life in and how has he breathed life into you and how did he speak you into being and</span>
                    <div class="segment-timestamp">03:10</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_29">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_29', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(202.95000000000002, 210.81000000000003)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_29', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_29', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-2" 
                          data-group="2" data-segment-id="seg_29"
                          data-start="202.95000000000002" 
                          data-end="210.81000000000003"
                          data-segment-id="seg_29"
                          data-words-count="0"
                          title="03:22 - 03:30"
                          onclick="handleSegmentClick(this, 202.95000000000002, 210.81000000000003, 'seg_29')"
                          contenteditable="false">How did he speak you into being and how did he speak you into being and life?</span>
                    <div class="segment-timestamp">03:22</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_30">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_30', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(213.43000000000004, 216.45000000000002)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_30', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_30', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment duplicate-highlight duplicate-group-5" 
                          data-group="5" data-segment-id="seg_30"
                          data-start="213.43000000000004" 
                          data-end="216.45000000000002"
                          data-segment-id="seg_30"
                          data-words-count="0"
                          title="03:33 - 03:36"
                          onclick="handleSegmentClick(this, 213.43000000000004, 216.45000000000002, 'seg_30')"
                          contenteditable="false">Share your revelations in the comments.</span>
                    <div class="segment-timestamp">03:33</div>
                </div>
                <div class="transcript-line" data-segment-id="seg_31">
                    <div class="segment-controls">
                        <button class="segment-group-btn" onclick="openSegmentGroupMenu('seg_31', event)" title="Assign to group">üìã</button>
                        <button class="segment-play-btn" onclick="playSegment(216.43000000000004, 218.45000000000002)" title="Play segment">‚ñ∂Ô∏è</button>
                        <button class="segment-split-btn" onclick="openSplitDialog('seg_31', event)" title="Split segment">‚úÇÔ∏è</button>
                        <button class="segment-merge-btn" onclick="toggleMergeMode('seg_31', event)" title="Merge with adjacent">üîó</button>
                    </div>
                    <span class="transcript-segment " 
                          
                          data-start="216.43000000000004" 
                          data-end="218.45000000000002"
                          data-segment-id="seg_31"
                          data-words-count="0"
                          title="03:36 - 03:38"
                          onclick="handleSegmentClick(this, 216.43000000000004, 218.45000000000002, 'seg_31')"
                          contenteditable="false">In love and unity, Aceh Vail.</span>
                    <div class="segment-timestamp">03:36</div>
                </div></div></div>

        <div class="video-section">
            <h2>üé¨ Video Grid Comparison</h2>
            <div class="grid-controls">
            <div class="grid-size-control">
                <label for="gridSize">Grid Size:</label>
                <select id="gridSize">
                    <option value="1">1 (Single)</option>
                    <option value="2" selected>2 (Side-by-side)</option>
                    <option value="4">4 (2x2 Grid)</option>
                </select>
            </div>
                <div class="group-selector">
                    <label for="groupSelect">Select Group:</label>
                    <select id="groupSelect">
                        <option value="">Choose a group...</option>
                    </select>
                </div>
                <div class="grid-info">
                    <span id="gridStatus">Select a group to compare segments</span>
                </div>
            </div>
            <div class="video-grid" id="videoGrid">
                <div class="grid-placeholder">
                    <div class="placeholder-icon">üé¨</div>
                    <p>Select a duplicate group to view side-by-side comparison</p>
                </div>
            </div>
            <div class="grid-pagination" id="gridPagination" style="display: none;">
                <button class="pagination-btn" id="prevPage" onclick="changeGridPage(-1)">‚Üê Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="pagination-btn" id="nextPage" onclick="changeGridPage(1)">Next ‚Üí</button>
            </div>
            <div class="grid-controls-panel">
                <div class="clip-controls">
                    <label>
                        <input type="checkbox" id="loopClips" checked> Loop Clips
                    </label>
                </div>
                <div class="grid-info-text">
                    <span>üìπ Use individual video controls for each segment</span>
                </div>
            </div>
        </div>



        <div class="footer">
            <p>Interactive duplicate detection with editing capabilities ‚Ä¢ Processing time: 0.0 seconds</p>
        </div>
    </div>

    <script>
        let editMode = false;
        let selectedSegments = [];
        let groupCounter = 9;
        
        // Video Grid Variables
        let currentGroup = null;
        let currentPage = 0;
        let gridSize = 2;
        let gridVideos = [];
        let loopClips = true;
        
        // Debug: Check what transcript_segments contains
        console.log('transcript_segments type:', typeof transcript_segments);
        console.log('transcript_segments length:', transcript_segments ? transcript_segments.length : 'null/undefined');
        if (transcript_segments && transcript_segments.length > 0) {
            console.log('First segment type:', typeof transcript_segments[0]);
            console.log('First segment keys:', transcript_segments[0] ? Object.keys(transcript_segments[0]) : 'no keys');
            console.log('First segment words:', transcript_segments[0] ? transcript_segments[0].words : 'no words');
        }
        
        // Transcript data with word-level timings
        let transcriptSegments = [{"segment_id": "seg_0", "text": "Where there was not God's book and then there was.", "start": 1.68, "end": 6.7, "words": []}, {"segment_id": "seg_1", "text": "Welcome to Life is Your Word episode 3.", "start": 7.68, "end": 10.7, "words": []}, {"segment_id": "seg_2", "text": "In this show, we build up our understanding of reality by seeking God's face.", "start": 11.68, "end": 17.7, "words": []}, {"segment_id": "seg_3", "text": "Today's reading is from Genesis chapter 1.", "start": 20.44, "end": 22.46, "words": []}, {"segment_id": "seg_4", "text": "When God began to create the heavens and the earth, the earth was in complete chaos and", "start": 27.200000000000003, "end": 34.11, "words": []}, {"segment_id": "seg_5", "text": "darkness covered the face of the deep while a wind of God, while a wind from God", "start": 35.010000000000005, "end": 42.42, "words": []}, {"segment_id": "seg_6", "text": "swept over the face of the waters.", "start": 43.760000000000005, "end": 45.349000000000004, "words": []}, {"segment_id": "seg_7", "text": "Then God said, let there be light and there was light.", "start": 47.803, "end": 50.74, "words": []}, {"segment_id": "seg_8", "text": "And God saw, and God saw that the light was good and", "start": 52.28, "end": 58.11, "words": []}, {"segment_id": "seg_9", "text": "God separated the light from the darkness.", "start": 59.53, "end": 61.95, "words": []}, {"segment_id": "seg_10", "text": "God created humans in the image of God.", "start": 62.49, "end": 65.87, "words": []}, {"segment_id": "seg_11", "text": "God blessed them, saying be fruitful and fill the earth.", "start": 67.00999999999999, "end": 72.456, "words": []}, {"segment_id": "seg_12", "text": "I have given you everything.", "start": 74.104, "end": 75.43, "words": []}, {"segment_id": "seg_13", "text": "In my past death, I lived in complete chaos and the great darkness of depression covered my face.", "start": 79.62, "end": 90.64000000000001, "words": []}, {"segment_id": "seg_14", "text": "I stopped listening to God's voice and I tried to run my race in my strength, in my strength, and I tried to run my race in my strength, rather than by Christ living in me.", "start": 90.62, "end": 104.64000000000001, "words": []}, {"segment_id": "seg_15", "text": "But God's, but then God spoke and I became.", "start": 104.62, "end": 110.64000000000001, "words": []}, {"segment_id": "seg_16", "text": "Life filled me, peace beyond human understanding, joy that defied worldly authorities,", "start": 110.62, "end": 119.64000000000001, "words": []}, {"segment_id": "seg_17", "text": "and I became compelled to shout God's praise from every mountaintop and share God's great works with everyone.", "start": 119.62, "end": 128.64000000000001, "words": []}, {"segment_id": "seg_18", "text": "So I thank God regularly for my role in partaking in creation as", "start": 131.42000000000002, "end": 136.44000000000003, "words": []}, {"segment_id": "seg_19", "text": "I create these things for your benefit just as God created all things for our benefit.", "start": 137.10000000000002, "end": 142.76000000000002, "words": []}, {"segment_id": "seg_20", "text": "This reminds me, this reminds me that nothing is impossible", "start": 143.26000000000002, "end": 148.44000000000003, "words": []}, {"segment_id": "seg_21", "text": "through Christ who gives me strength.", "start": 149.46, "end": 151.48000000000002, "words": []}, {"segment_id": "seg_22", "text": "This reminds me that nothing is impossible through Christ who gives me strength.", "start": 153.51000000000002, "end": 158.21, "words": []}, {"segment_id": "seg_23", "text": "The one who speaks all things into being can transform your life too.", "start": 159.19000000000003, "end": 167.33, "words": []}, {"segment_id": "seg_24", "text": "What death have you lived?", "start": 172.11, "end": 175.45000000000002, "words": []}, {"segment_id": "seg_25", "text": "They...", "start": 177.11, "end": 179.21, "words": []}, {"segment_id": "seg_26", "text": "What death have you experienced that he needs?", "start": 179.19, "end": 182.13000000000002, "words": []}, {"segment_id": "seg_27", "text": "What death have you experienced and how has he breathed life into your death and", "start": 185.36, "end": 190.12000000000003, "words": []}, {"segment_id": "seg_28", "text": "How has he breathed life in and how has he breathed life into you and how did he speak you into being and", "start": 190.72000000000003, "end": 201.33, "words": []}, {"segment_id": "seg_29", "text": "How did he speak you into being and how did he speak you into being and life?", "start": 202.95000000000002, "end": 210.81000000000003, "words": []}, {"segment_id": "seg_30", "text": "Share your revelations in the comments.", "start": 213.43000000000004, "end": 216.45000000000002, "words": []}, {"segment_id": "seg_31", "text": "In love and unity, Aceh Vail.", "start": 216.43000000000004, "end": 218.45000000000002, "words": []}];
        
        // Split/merge state
        let mergeMode = false;
        let selectedForMerge = [];
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function initializeVideoGrid() {
            const groupSelect = document.getElementById('groupSelect');
            const gridSizeSelect = document.getElementById('gridSize');
            
            // Populate group selector
            const groups = new Set();
            document.querySelectorAll('[data-group]').forEach(segment => {
                const groupId = segment.getAttribute('data-group');
                if (groupId) groups.add(groupId);
            });
            
            groups.forEach(groupId => {
                const option = document.createElement('option');
                option.value = groupId;
                option.textContent = `Group ${groupId} (${document.querySelectorAll(`[data-group="${groupId}"]`).length} segments)`;
                groupSelect.appendChild(option);
            });
            
            // Event listeners
            groupSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    loadGroupToGrid(e.target.value);
                } else {
                    clearGrid();
                }
            });
            
            gridSizeSelect.addEventListener('change', (e) => {
                gridSize = parseInt(e.target.value);
                updateGridSize();
                if (currentGroup) {
                    loadGroupToGrid(currentGroup);
                }
            });
            
            document.getElementById('loopClips').addEventListener('change', (e) => {
                loopClips = e.target.checked;
            });
        }
        
        function loadGroupToGrid(groupId) {
            currentGroup = groupId;
            currentPage = 0;
            
            const segments = document.querySelectorAll(`[data-group="${groupId}"]`);
            const segmentData = [];
            
            segments.forEach(segment => {
                segmentData.push({
                    id: segment.getAttribute('data-segment-id'),
                    text: segment.textContent,
                    start: parseFloat(segment.getAttribute('data-start')),
                    end: parseFloat(segment.getAttribute('data-end')),
                    element: segment
                });
            });
            
            // Sort by start time
            segmentData.sort((a, b) => a.start - b.start);
            
            gridVideos = segmentData;
            renderGridPage();
            updateGridStatus();
        }
        
        function renderGridPage() {
            const grid = document.getElementById('videoGrid');
            const videosPerPage = gridSize; // Simplified: 1, 2, or 4 videos
            const startIndex = currentPage * videosPerPage;
            const endIndex = Math.min(startIndex + videosPerPage, gridVideos.length);
            const pageVideos = gridVideos.slice(startIndex, endIndex);
            
            // Clear grid
            grid.innerHTML = '';
            
            if (pageVideos.length === 0) {
                grid.innerHTML = `
                    <div class="grid-placeholder">
                        <div class="placeholder-icon">üé¨</div>
                        <p>No videos in this group</p>
                    </div>
                `;
                return;
            }
            
            // Create video items
            pageVideos.forEach((videoData, index) => {
                const videoItem = createVideoItem(videoData, startIndex + index);
                grid.appendChild(videoItem);
            });
            
            updatePagination();
        }
        
        function createVideoItem(videoData, index) {
            const item = document.createElement('div');
            item.className = 'video-item';
            item.innerHTML = `
                <div class="video-header">
                    Segment ${index + 1} ‚Ä¢ ${formatTime(videoData.start)} - ${formatTime(videoData.end)}
                </div>
                <div class="video-content">
                    <video id="grid-video-${index}" 
                           data-start="${videoData.start}" 
                           data-end="${videoData.end}"
                           controls
                           preload="metadata">
                        <source src="/home/asabaal/episode3_combined/combined_video.mp4" type="video/mp4">
                    </video>
                    <div class="video-overlay">
                        <div class="video-time">${formatTime(videoData.start)} - ${formatTime(videoData.end)}</div>
                        <div class="video-text">${videoData.text}</div>
                    </div>
                </div>
            `;
            
            // Setup video behavior for individual controls
            const video = item.querySelector('video');
            video.addEventListener('loadedmetadata', () => {
                video.currentTime = videoData.start;
            });
            
            video.addEventListener('timeupdate', () => {
                // Respect clip boundaries even with individual controls
                if (video.currentTime >= videoData.end - 0.1) {
                    if (loopClips) {
                        video.currentTime = videoData.start;
                    } else {
                        video.pause();
                        video.currentTime = videoData.start; // Reset to beginning
                    }
                }
                
                // Prevent seeking outside clip boundaries
                if (video.currentTime < videoData.start) {
                    video.currentTime = videoData.start;
                }
            });
            
            video.addEventListener('seeking', () => {
                // Keep within clip boundaries
                if (video.currentTime < videoData.start) {
                    video.currentTime = videoData.start;
                } else if (video.currentTime > videoData.end) {
                    video.currentTime = videoData.end;
                }
            });
            
            video.addEventListener('play', () => {
                document.querySelectorAll('.video-item').forEach(v => v.classList.remove('active'));
                item.classList.add('active');
            });
            
            return item;
        }
        

        
        function updateGridSize() {
            const grid = document.getElementById('videoGrid');
            grid.className = `video-grid size-${gridSize}`;
        }
        
        function updatePagination() {
            const videosPerPage = gridSize; // Simplified: 1, 2, or 4 videos
            const totalPages = Math.ceil(gridVideos.length / videosPerPage);
            const pagination = document.getElementById('gridPagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = currentPage === totalPages - 1;
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages}`;
        }
        
        function changeGridPage(direction) {
            const videosPerPage = gridSize; // Simplified: 1, 2, or 4 videos
            const totalPages = Math.ceil(gridVideos.length / videosPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 0 && newPage < totalPages) {
                currentPage = newPage;
                renderGridPage();
            }
        }
        
        function updateGridStatus() {
            const status = document.getElementById('gridStatus');
            if (currentGroup && gridVideos.length > 0) {
                status.textContent = `Group ${currentGroup}: ${gridVideos.length} segments loaded`;
            } else {
                status.textContent = 'Select a group to compare segments';
            }
        }
        
        function clearGrid() {
            currentGroup = null;
            gridVideos = [];
            currentPage = 0;
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = `
                <div class="grid-placeholder">
                    <div class="placeholder-icon">üé¨</div>
                    <p>Select a duplicate group to view side-by-side comparison</p>
                </div>
            `;
            document.getElementById('gridPagination').style.display = 'none';
            updateGridStatus();
        }
        

        
        function handleSegmentClick(element, startTime, endTime, segmentId) {
            if (editMode) {
                toggleSegmentEdit(element);
            } else {
                if (event.shiftKey && selectedSegments.length > 0) {
                    // Shift+click for multi-selection
                    selectSegment(element, segmentId);
                } else if (event.ctrlKey || event.metaKey) {
                    // Ctrl/Cmd+click for toggle selection
                    toggleSegmentSelection(element, segmentId);
                } else {
                    // Normal click - load group to grid if segment is in a group
                    const groupId = element.getAttribute('data-group');
                    if (groupId) {
                        document.getElementById('groupSelect').value = groupId;
                        loadGroupToGrid(groupId);
                        
                        // Scroll to video grid
                        document.getElementById('videoGrid').scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }
        
        function toggleEditMode() {
            editMode = !editMode;
            const button = document.querySelector('.toggle-edit-mode');
            const saveButton = document.getElementById('saveButton');
            const editIndicator = document.getElementById('editIndicator');
            
            button.textContent = editMode ? 'üîí Lock Editing' : '‚úèÔ∏è Toggle Edit Mode';
            
            if (editMode) {
                saveButton.style.display = 'inline-block';
                editIndicator.classList.add('show');
            } else {
                saveButton.style.display = 'none';
                editIndicator.classList.remove('show');
            }
            
            // Make all segments editable/non-editable
            document.querySelectorAll('.transcript-segment').forEach(segment => {
                segment.contentEditable = editMode;
                if (editMode) {
                    segment.style.backgroundColor = 'rgba(66, 153, 225, 0.05)';
                    segment.addEventListener('input', handleSegmentEdit);
                } else {
                    segment.style.backgroundColor = '';
                    segment.removeEventListener('input', handleSegmentEdit);
                }
            });
            
            updateWordCount();
        }
        
        function handleSegmentEdit(event) {
            updateWordCount();
            // Auto-save to browser storage every 2 seconds of inactivity
            clearTimeout(window.autoSaveTimer);
            window.autoSaveTimer = setTimeout(() => {
                autoSaveToStorage();
            }, 2000);
        }
        
        function updateWordCount() {
            const segments = document.querySelectorAll('.transcript-segment');
            let wordCount = 0;
            segments.forEach(segment => {
                wordCount += segment.textContent.trim().split(/\s+/).length;
            });
            document.getElementById('wordCount').textContent = `${wordCount} words`;
        }
        
        function autoSaveToStorage() {
            const transcriptData = getTranscriptData();
            localStorage.setItem('transcriptDraft', JSON.stringify(transcriptData));
            console.log('Auto-saved to browser storage');
        }
        
        function getTranscriptData() {
            const segments = [];
            document.querySelectorAll('.transcript-segment').forEach(segment => {
                segments.push({
                    segment_id: segment.getAttribute('data-segment-id') || '',
                    text: segment.textContent,
                    start: parseFloat(segment.getAttribute('data-start')),
                    end: parseFloat(segment.getAttribute('data-end')),
                    group: segment.getAttribute('data-group') || null
                });
            });
            return {
                segments: segments,
                total_segments: segments.length,
                last_edited: new Date().toISOString()
            };
        }
        
        function saveTranscript() {
            try {
                const transcriptData = getTranscriptData();
                const jsonData = JSON.stringify(transcriptData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `edited_transcript_${timestamp}.json`;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show success message
                showSaveStatus('Transcript saved successfully!', 'success');
                
                // Clear browser storage
                localStorage.removeItem('transcriptDraft');
                
            } catch (error) {
                showSaveStatus('Error saving transcript: ' + error.message, 'error');
            }
        }
        
        function downloadTranscript() {
            const transcriptData = getTranscriptData();
            
            // Create different format options
            const format = prompt('Choose format:\n1. JSON (with timestamps)\n2. Plain text\n3. SRT subtitles\nEnter choice (1-3):', '1');
            
            let content, filename, mimeType;
            
            switch(format) {
                case '2':
                    // Plain text
                    content = transcriptData.segments.map(seg => seg.text).join(' ');
                    filename = `transcript_text_${new Date().toISOString().slice(0, 10)}.txt`;
                    mimeType = 'text/plain';
                    break;
                    
                case '3':
                    // SRT format
                    content = generateSRT(transcriptData.segments);
                    filename = `transcript_${new Date().toISOString().slice(0, 10)}.srt`;
                    mimeType = 'text/plain';
                    break;
                    
                default:
                    // JSON format
                    content = JSON.stringify(transcriptData, null, 2);
                    filename = `transcript_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.json`;
                    mimeType = 'application/json';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSaveStatus(`Downloaded ${filename}`, 'success');
        }
        
        function generateSRT(segments) {
            return segments.map((seg, index) => {
                const startTime = formatSRTTime(seg.start);
                const endTime = formatSRTTime(seg.end);
                return `${index + 1}\n${startTime} --> ${endTime}\n${seg.text}\n`;
            }).join('\n');
        }
        
        function formatSRTTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
        }
        
        function showSaveStatus(message, type) {
            const statusElement = document.getElementById('saveStatus');
            statusElement.textContent = message;
            statusElement.className = `save-status ${type}`;
            
            setTimeout(() => {
                statusElement.className = 'save-status';
            }, 3000);
        }
        
        function loadDraftFromStorage() {
            try {
                const draft = localStorage.getItem('transcriptDraft');
                if (draft) {
                    const transcriptData = JSON.parse(draft);
                    const lastEdited = new Date(transcriptData.last_edited);
                    const timeDiff = Date.now() - lastEdited.getTime();
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24 && confirm(`Found unsaved draft from ${lastEdited.toLocaleString()}. Load it?`)) {
                        // Apply draft changes
                        transcriptData.segments.forEach(draftSeg => {
                            const segment = document.querySelector(`[data-segment-id="${draftSeg.segment_id}"]`);
                            if (segment) {
                                segment.textContent = draftSeg.text;
                            }
                        });
                        showSaveStatus('Draft loaded successfully', 'success');
                    }
                }
            } catch (error) {
                console.error('Error loading draft:', error);
            }
        }
        
        function toggleSegmentEdit(element) {
            if (element.contentEditable === 'true') {
                element.contentEditable = 'false';
                element.style.backgroundColor = '';
                // Save changes here if needed
                console.log('Saved:', element.textContent);
            } else {
                element.contentEditable = 'true';
                element.style.backgroundColor = 'white';
                element.focus();
                
                // Select all text
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }
        
        function selectSegment(element, segmentId) {
            if (!selectedSegments.find(s => s.id === segmentId)) {
                selectedSegments.push({element, id: segmentId});
                element.style.outline = '2px solid #4299e1';
                element.style.outlineOffset = '2px';
            }
        }
        
        function toggleSegmentSelection(element, segmentId) {
            const index = selectedSegments.findIndex(s => s.id === segmentId);
            if (index > -1) {
                selectedSegments.splice(index, 1);
                element.style.outline = '';
                element.style.outlineOffset = '';
            } else {
                selectSegment(element, segmentId);
            }
        }
        
        function createNewGroup() {
            if (selectedSegments.length < 2) {
                alert('Please select at least 2 segments to create a group. Use Ctrl+click to select multiple segments.');
                return;
            }
            
            const groupNum = groupCounter++;
            const groupColor = getGroupColor(groupNum);
            
            selectedSegments.forEach(({element}) => {
                element.classList.add('duplicate-highlight', `duplicate-group-${groupNum}`);
                element.setAttribute('data-group', groupNum);
                element.style.outline = '';
                element.style.outlineOffset = '';
            });
            
            // Clear selection
            selectedSegments = [];
            
            alert(`Created duplicate group ${groupNum} with ${selectedSegments.length} segments.`);
        }
        
        function getGroupColor(groupNum) {
            const colors = [
                {bg: '#fed7d7', hover: '#fc8181', border: '#f56565'},
                {bg: '#feebc8', hover: '#f6ad55', border: '#ed8936'},
                {bg: '#b2f5ea', hover: '#4fd1c5', border: '#38b2ac'},
                {bg: '#e9d8fd', hover: '#b794f4', border: '#805ad5'},
                {bg: '#faf089', hover: '#f6e05e', border: '#d69e2e'}
            ];
            return colors[(groupNum - 1) % colors.length];
        }
        
        function removeFromGroup(element) {
            const groupNum = element.getAttribute('data-group');
            if (groupNum) {
                element.classList.remove('duplicate-highlight', `duplicate-group-${groupNum}`);
                element.removeAttribute('data-group');
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' && e.target.tagName !== 'INPUT' && e.target.contentEditable !== 'true') {
                e.preventDefault();
                const video = document.getElementById('videoPlayer');
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            }
            
            if (e.key === 'Escape') {
                // Clear selections
                selectedSegments.forEach(({element}) => {
                    element.style.outline = '';
                    element.style.outlineOffset = '';
                });
                selectedSegments = [];
            }
            
            if (e.key === 'Delete' && selectedSegments.length > 0) {
                // Remove selected segments from their groups
                selectedSegments.forEach(({element}) => {
                    removeFromGroup(element);
                });
                selectedSegments = [];
            }
        });
        
        // Add right-click context menu for segments
        document.addEventListener('contextmenu', (e) => {
            if (e.target.classList.contains('transcript-segment')) {
                e.preventDefault();
                // Could add context menu here
                console.log('Right-click on segment:', e.target.textContent);
            }
        });
        
        // Initialize editor and playback mode listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load any unsaved draft
            loadDraftFromStorage();
            
            // Initialize word count
            updateWordCount();
            
            // Initialize video grid
            initializeVideoGrid();
            
            // Populate group selector
            const groups = new Set();
            document.querySelectorAll('[data-group]').forEach(segment => {
                const groupId = segment.getAttribute('data-group');
                if (groupId) groups.add(groupId);
            });
            
            groups.forEach(groupId => {
                const option = document.createElement('option');
                option.value = groupId;
                option.textContent = `Group ${groupId}`;
                groupSelect.appendChild(option);
            });
            
            // Handle playback mode changes
            playbackModes.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'group') {
                        groupSelector.style.display = 'flex';
                    } else {
                        groupSelector.style.display = 'none';
                        clipQueue = [];
                        currentClipIndex = 0;
                        isPlayingQueue = false;
                        updatePlaylistDisplay();
                    }
                });
            });
            
            // Handle group selection
            groupSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    playGroupClips(e.target.value);
                }
            });
            
            // Initialize playlist display
            updatePlaylistDisplay();
        });
        
        // Group Management Functions
        
        function openSegmentGroupMenu(segmentId, event) {
            event.stopPropagation();
            
            // Create or get the group menu
            let menu = document.getElementById('segmentGroupMenu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'segmentGroupMenu';
                menu.className = 'segment-group-menu';
                document.body.appendChild(menu);
            }
            
            // Get current groups
            const currentGroups = new Set();
            document.querySelectorAll('.transcript-segment[data-group]').forEach(seg => {
                currentGroups.add(seg.getAttribute('data-group'));
            });
            
            // Get current segment's group
            const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
            const currentGroup = segment ? segment.getAttribute('data-group') : null;
            
            // Build menu HTML
            let menuHTML = `
                <div class="group-menu-header">Assign to Group:</div>
                <div class="group-menu-item" onclick="assignSegmentToGroup('${segmentId}', null)">
                    üö´ Remove from Group
                </div>
                <div class="group-menu-divider"></div>
                <div class="group-menu-item" onclick="createNewGroupForSegment('${segmentId}')">
                    ‚ûï Create New Group
                </div>
                <div class="group-menu-divider"></div>
            `;
            
            // Add existing groups
            Array.from(currentGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(groupId => {
                const isSelected = currentGroup === groupId;
                menuHTML += `
                    <div class="group-menu-item ${isSelected ? 'selected' : ''}" 
                         onclick="assignSegmentToGroup('${segmentId}', '${groupId}')">
                        üìÅ Group ${groupId} ${isSelected ? '‚úì' : ''}
                    </div>
                `;
            });
            
            menu.innerHTML = menuHTML;
            
            // Position menu
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            
            // Show menu
            menu.style.display = 'block';
            
            // Hide menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', hideSegmentGroupMenu, { once: true });
            }, 100);
        }
        
        function hideSegmentGroupMenu() {
            const menu = document.getElementById('segmentGroupMenu');
            if (menu) {
                menu.style.display = 'none';
            }
        }
        
        function assignSegmentToGroup(segmentId, groupId) {
            const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
            if (!segment) return;
            
            // Remove existing group classes
            segment.className = segment.className.replace(/duplicate-group-\d+/g, '').replace(/duplicate-highlight/g, '').trim();
            
            if (groupId) {
                // Assign to group
                segment.setAttribute('data-group', groupId);
                segment.classList.add('duplicate-highlight', `duplicate-group-${groupId}`);
            } else {
                // Remove from group
                segment.removeAttribute('data-group');
            }
            
            // Update video grid if needed
            updateVideoGridOptions();
            
            // Auto-save
            autoSaveToStorage();
            
            hideSegmentGroupMenu();
        }
        
        function createNewGroupForSegment(segmentId) {
            const newGroupId = prompt('Enter new group number (or leave empty for auto-assignment):');
            if (newGroupId === null) return; // User cancelled
            
            let groupId = newGroupId.trim();
            if (!groupId) {
                // Auto-assign next available group number
                const existingGroups = new Set();
                document.querySelectorAll('.transcript-segment[data-group]').forEach(seg => {
                    existingGroups.add(parseInt(seg.getAttribute('data-group')));
                });
                
                groupId = '1';
                while (existingGroups.has(parseInt(groupId))) {
                    groupId = (parseInt(groupId) + 1).toString();
                }
            }
            
            assignSegmentToGroup(segmentId, groupId);
        }
        
        function openGroupEditor() {
            // Get all segments grouped by group
            const groups = {};
            document.querySelectorAll('.transcript-segment[data-group]').forEach(seg => {
                const groupId = seg.getAttribute('data-group');
                if (!groups[groupId]) groups[groupId] = [];
                groups[groupId].push(seg);
            });
            
            // Build editor HTML
            let editorHTML = `
                <div class="group-editor-overlay">
                    <div class="group-editor">
                        <div class="group-editor-header">
                            <h3>üìù Group Editor</h3>
                            <button class="close-btn" onclick="closeGroupEditor()">‚úï</button>
                        </div>
                        <div class="group-editor-content">
            `;
            
            if (Object.keys(groups).length === 0) {
                editorHTML += `
                    <div class="no-groups-message">
                        <p>No groups found. Use the üìã button on transcript lines to create groups.</p>
                    </div>
                `;
            } else {
                Object.keys(groups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(groupId => {
                    editorHTML += `
                        <div class="group-editor-group" data-group="${groupId}">
                            <div class="group-editor-group-header">
                                <h4>üìÅ Group ${groupId} (${groups[groupId].length} segments)</h4>
                                <div class="group-actions">
                                    <button class="group-action-btn" onclick="renameGroup('${groupId}')">‚úèÔ∏è Rename</button>
                                    <button class="group-action-btn delete" onclick="deleteGroup('${groupId}')">üóëÔ∏è Delete</button>
                                    <button class="group-action-btn" onclick="loadGroupToGrid('${groupId}')">üé¨ View in Grid</button>
                                </div>
                            </div>
                            <div class="group-segments">
                    `;
                    
                    groups[groupId].forEach((seg, index) => {
                        const segmentId = seg.getAttribute('data-segment-id');
                        const startTime = seg.getAttribute('data-start');
                        const endTime = seg.getAttribute('data-end');
                        const text = seg.textContent.trim();
                        
                        editorHTML += `
                            <div class="group-segment-item" data-segment-id="${segmentId}">
                                <div class="segment-info">
                                    <span class="segment-index">${index + 1}.</span>
                                    <span class="segment-time">‚è∞ ${formatTime(startTime)} - ${formatTime(endTime)}</span>
                                    <button class="segment-play-small" onclick="playSegment(${startTime}, ${endTime})">‚ñ∂Ô∏è</button>
                                </div>
                                <div class="segment-text">${text}</div>
                                <button class="remove-segment-btn" onclick="removeSegmentFromGroup('${segmentId}', '${groupId}')">‚úï</button>
                            </div>
                        `;
                    });
                    
                    editorHTML += `
                            </div>
                        </div>
                    `;
                });
            }
            
            editorHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            // Create and show editor
            const editorOverlay = document.createElement('div');
            editorOverlay.innerHTML = editorHTML;
            document.body.appendChild(editorOverlay.firstElementChild);
        }
        
        function closeGroupEditor() {
            const editor = document.querySelector('.group-editor-overlay');
            if (editor) {
                editor.remove();
            }
        }
        
        function renameGroup(oldGroupId) {
            const newGroupId = prompt(`Enter new group number for Group ${oldGroupId}:`, oldGroupId);
            if (newGroupId && newGroupId !== oldGroupId) {
                // Update all segments in this group
                document.querySelectorAll(`[data-group="${oldGroupId}"]`).forEach(seg => {
                    seg.setAttribute('data-group', newGroupId);
                    seg.className = seg.className.replace(/duplicate-group-\d+/g, '').replace(/duplicate-highlight/g, '').trim();
                    seg.classList.add('duplicate-highlight', `duplicate-group-${newGroupId}`);
                });
                
                updateVideoGridOptions();
                autoSaveToStorage();
                openGroupEditor(); // Refresh the editor
            }
        }
        
        function deleteGroup(groupId) {
            if (confirm(`Are you sure you want to delete Group ${groupId}? This will remove all segments from the group.`)) {
                document.querySelectorAll(`[data-group="${groupId}"]`).forEach(seg => {
                    seg.removeAttribute('data-group');
                    seg.className = seg.className.replace(/duplicate-group-\d+/g, '').replace(/duplicate-highlight/g, '').trim();
                });
                
                updateVideoGridOptions();
                autoSaveToStorage();
                openGroupEditor(); // Refresh the editor
            }
        }
        
        function removeSegmentFromGroup(segmentId, groupId) {
            if (confirm(`Remove this segment from Group ${groupId}?`)) {
                assignSegmentToGroup(segmentId, null);
                openGroupEditor(); // Refresh the editor
            }
        }
        
        function updateVideoGridOptions() {
            // Update the group selector in video grid
            const groupSelect = document.getElementById('groupSelect');
            if (!groupSelect) return;
            
            const currentValue = groupSelect.value;
            groupSelect.innerHTML = '<option value="">Choose a group...</option>';
            
            const groups = new Set();
            document.querySelectorAll('.transcript-segment[data-group]').forEach(seg => {
                groups.add(seg.getAttribute('data-group'));
            });
            
            Array.from(groups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(groupId => {
                const option = document.createElement('option');
                option.value = groupId;
                option.textContent = `Group ${groupId}`;
                groupSelect.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue && groups.has(currentValue)) {
                groupSelect.value = currentValue;
            }
        }
        
        // Split/Merge Functions
        
        function openSplitDialog(segmentId, event) {
            event.stopPropagation();
            
            const segment = transcriptSegments.find(seg => seg.segment_id === segmentId);
            if (!segment || !segment.words || segment.words.length < 2) {
                alert('This segment cannot be split (no word-level timing data available).');
                return;
            }
            
            // Create split dialog
            const dialog = document.createElement('div');
            dialog.className = 'split-dialog-overlay';
            dialog.innerHTML = `
                <div class="split-dialog">
                    <div class="split-dialog-header">
                        <h3>‚úÇÔ∏è Split Segment</h3>
                        <button class="close-btn" onclick="closeSplitDialog()">‚úï</button>
                    </div>
                    <div class="split-dialog-content">
                        <p>Choose where to split this segment:</p>
                        <div class="words-container">
                            ${segment.words.map((word, index) => `
                                <span class="word-item" data-index="${index}" onclick="toggleSplitPoint(${index})">
                                    ${word.text}
                                </span>
                            `).join(' ')}
                        </div>
                        <div class="split-preview">
                            <div class="preview-part">
                                <strong>Part 1:</strong> <span id="part1-text">${segment.words[0].text}</span>
                                <span id="part1-time">${formatTime(segment.words[0].start)} - ${formatTime(segment.words[0].end)}</span>
                            </div>
                            <div class="preview-part">
                                <strong>Part 2:</strong> <span id="part2-text">${segment.words.slice(1).map(w => w.text).join(' ')}</span>
                                <span id="part2-time">${formatTime(segment.words[1].start)} - ${formatTime(segment.words[segment.words.length - 1].end)}</span>
                            </div>
                        </div>
                        <div class="split-dialog-actions">
                            <button class="cancel-btn" onclick="closeSplitDialog()">Cancel</button>
                            <button class="split-confirm-btn" onclick="confirmSplit('${segmentId}')">Split Segment</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // Set initial split point after first word
            toggleSplitPoint(0);
        }
        
        function closeSplitDialog() {
            const dialog = document.querySelector('.split-dialog-overlay');
            if (dialog) dialog.remove();
        }
        
        let selectedSplitIndex = 0;
        
        function toggleSplitPoint(index) {
            selectedSplitIndex = index;
            
            // Update word highlighting
            document.querySelectorAll('.word-item').forEach((word, i) => {
                if (i <= index) {
                    word.classList.add('part1');
                } else {
                    word.classList.add('part2');
                }
            });
            
            // Update preview
            const segment = transcriptSegments.find(seg => seg.segment_id === document.querySelector('.split-confirm-btn').getAttribute('onclick').match(/'([^']+)'/)[1]);
            const part1Words = segment.words.slice(0, index + 1);
            const part2Words = segment.words.slice(index + 1);
            
            document.getElementById('part1-text').textContent = part1Words.map(w => w.text).join(' ');
            document.getElementById('part1-time').textContent = `${formatTime(part1Words[0].start)} - ${formatTime(part1Words[part1Words.length - 1].end)}`;
            
            if (part2Words.length > 0) {
                document.getElementById('part2-text').textContent = part2Words.map(w => w.text).join(' ');
                document.getElementById('part2-time').textContent = `${formatTime(part2Words[0].start)} - ${formatTime(part2Words[part2Words.length - 1].end)}`;
            } else {
                document.getElementById('part2-text').textContent = '(empty)';
                document.getElementById('part2-time').textContent = '-';
            }
        }
        
        function confirmSplit(segmentId) {
            const segment = transcriptSegments.find(seg => seg.segment_id === segmentId);
            const part1Words = segment.words.slice(0, selectedSplitIndex + 1);
            const part2Words = segment.words.slice(selectedSplitIndex + 1);
            
            if (part2Words.length === 0) {
                alert('Cannot create empty segment. Please choose a different split point.');
                return;
            }
            
            // Create two new segments
            const part1Segment = {
                segment_id: `${segmentId}_part1`,
                text: part1Words.map(w => w.text).join(' '),
                start: part1Words[0].start,
                end: part1Words[part1Words.length - 1].end,
                words: part1Words
            };
            
            const part2Segment = {
                segment_id: `${segmentId}_part2`,
                text: part2Words.map(w => w.text).join(' '),
                start: part2Words[0].start,
                end: part2Words[part2Words.length - 1].end,
                words: part2Words
            };
            
            // Update transcript data
            const index = transcriptSegments.findIndex(seg => seg.segment_id === segmentId);
            transcriptSegments.splice(index, 1, part1Segment, part2Segment);
            
            // Update UI
            updateTranscriptDisplay();
            closeSplitDialog();
            
            // Auto-save
            autoSaveToStorage();
        }
        
        function toggleMergeMode(segmentId, event) {
            event.stopPropagation();
            
            const line = document.querySelector(`[data-segment-id="${segmentId}"]`).closest('.transcript-line');
            const mergeBtn = line.querySelector('.segment-merge-btn');
            
            if (mergeMode) {
                // Exit merge mode
                exitMergeMode();
            } else {
                // Enter merge mode
                enterMergeMode();
            }
        }
        
        function enterMergeMode() {
            mergeMode = true;
            selectedForMerge = [];
            
            // Update all merge buttons
            document.querySelectorAll('.segment-merge-btn').forEach(btn => {
                btn.classList.add('active');
                btn.textContent = '‚ùå';
                btn.setAttribute('title', 'Exit merge mode');
            });
            
            // Add click handlers to lines
            document.querySelectorAll('.transcript-line').forEach(line => {
                line.addEventListener('click', handleMergeSelection);
                line.style.cursor = 'pointer';
            });
            
            // Show instructions
            showMergeInstructions();
        }
        
        function exitMergeMode() {
            mergeMode = false;
            selectedForMerge = [];
            
            // Reset merge buttons
            document.querySelectorAll('.segment-merge-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.textContent = 'üîó';
                btn.setAttribute('title', 'Merge with adjacent');
            });
            
            // Remove click handlers and highlighting
            document.querySelectorAll('.transcript-line').forEach(line => {
                line.removeEventListener('click', handleMergeSelection);
                line.classList.remove('merge-selected');
                line.style.cursor = 'default';
            });
            
            // Hide instructions
            hideMergeInstructions();
        }
        
        function handleMergeSelection(event) {
            if (!mergeMode) return;
            
            const line = event.currentTarget;
            const segmentId = line.getAttribute('data-segment-id');
            
            if (selectedForMerge.includes(segmentId)) {
                // Deselect
                selectedForMerge = selectedForMerge.filter(id => id !== segmentId);
                line.classList.remove('merge-selected');
            } else {
                // Select
                selectedForMerge.push(segmentId);
                line.classList.add('merge-selected');
            }
            
            // Update merge button text
            updateMergeButtonText();
        }
        
        function updateMergeButtonText() {
            if (selectedForMerge.length >= 2) {
                document.querySelectorAll('.segment-merge-btn.active').forEach(btn => {
                    btn.textContent = `üîó (${selectedForMerge.length})`;
                });
            } else {
                document.querySelectorAll('.segment-merge-btn.active').forEach(btn => {
                    btn.textContent = '‚ùå';
                });
            }
        }
        
        function showMergeInstructions() {
            const instructions = document.createElement('div');
            instructions.id = 'mergeInstructions';
            instructions.className = 'merge-instructions';
            instructions.innerHTML = `
                <div class="merge-instructions-content">
                    <strong>üîó Merge Mode</strong><br>
                    Click segments to select them for merging. Selected segments must be consecutive.
                    <button class="merge-confirm-btn" onclick="confirmMerge()" ${selectedForMerge.length < 2 ? 'disabled' : ''}>
                        Merge ${selectedForMerge.length} Segments
                    </button>
                    <button class="merge-cancel-btn" onclick="exitMergeMode()">Cancel</button>
                </div>
            `;
            document.querySelector('.transcript-section').appendChild(instructions);
        }
        
        function hideMergeInstructions() {
            const instructions = document.getElementById('mergeInstructions');
            if (instructions) instructions.remove();
        }
        
        function confirmMerge() {
            if (selectedForMerge.length < 2) {
                alert('Please select at least 2 segments to merge.');
                return;
            }
            
            // Check if segments are consecutive
            const indices = selectedForMerge.map(id => 
                transcriptSegments.findIndex(seg => seg.segment_id === id)
            ).sort((a, b) => a - b);
            
            for (let i = 1; i < indices.length; i++) {
                if (indices[i] !== indices[i-1] + 1) {
                    alert('Selected segments must be consecutive. Please select adjacent segments only.');
                    return;
                }
            }
            
            // Merge segments
            const segmentsToMerge = indices.map(i => transcriptSegments[i]);
            const mergedSegment = mergeSegments(segmentsToMerge);
            
            // Replace in transcript data
            transcriptSegments.splice(indices[0], indices.length, mergedSegment);
            
            // Update UI
            updateTranscriptDisplay();
            exitMergeMode();
            
            // Auto-save
            autoSaveToStorage();
        }
        
        function mergeSegments(segments) {
            const allWords = segments.flatMap(seg => seg.words || []);
            const mergedText = segments.map(seg => seg.text).join(' ');
            
            return {
                segment_id: `merged_${Date.now()}`,
                text: mergedText,
                start: segments[0].start,
                end: segments[segments.length - 1].end,
                words: allWords
            };
        }
        
        function updateTranscriptDisplay() {
            // This would regenerate the transcript HTML
            // For now, reload the page to show changes
            location.reload();
        }
    </script>
</body>
</html>